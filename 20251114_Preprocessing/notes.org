#+TITLE: fMRI Data Pre-processing

* Copy over data
:PROPERTIES:
:header-args:bash:  :tangle scripts/01_copy_data.sh
:header-args:bash+: :shebang "#!/usr/bin/env bash"
:header-args:bash+: :mkdirp yes
:END:

Copy over the data from network storage to CHPC.
#+begin_src bash
# * Copy data from the NAS to CHPC for processing

# * Environment
# ** Remote NAS (source)
r1id="vkoppelmans"
r1ip="eindhoven.synology.me"
r1dir="/volume1/Backup/Thalia/Kladblok/20190830_Koppelmans\
/20240816_NMD_fMRIprep_Tethys/data/20240715_BIDS"

# ** CHPC (target)
r2id="u6012627"
r2ip="notchpeak.chpc.utah.edu"
r2dir="/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Kladblok\
/20251114_NMD_fMRI"


# * Copy data from NAS to local
# NAS does not allow scp protocol, and rsync does not allow remote-to-remote
# copying, so I will need to copy the data over from NAS to local, and then from
# local to CHPC.

# ** Copy NAS to local
tdir=$(mktemp -d)
rsync -avmhe ssh ${r1id}@${r1ip}:${r1dir} "${tdir}"

# ** Copy local to CHPC
# * Create output folder
ssh "${r2id}@${r2ip}" mkdir -p "${r2dir}"

# ** Copy over the data
rsync -avmhe ssh "${tdir}/20240715_BIDS" ${r2id}@${r2ip}:${r2dir}
#+end_src

The total data size is 36.22G.

* Build fMRIprep on CHPC
:PROPERTIES:
:header-args:bash: :tangle no
:END:

#+NAME: build_fmriprep_chpc
#+begin_src bash
#SBATCH --account=koppelmans-np
#SBATCH --mail-user=u6012627@utah.edu
#SBATCH --partition=koppelmans-shared-np
#SBATCH --job-name=build_fmriprep
#SBATCH --nodes=1
#SBATCH --ntasks=20
#SBATCH --mem=24G
#SBATCH --time=3:00:00
#SBATCH -o build_fmriprep_sif-%j.out-%N
#SBATCH -e build_fmriprep_sif-%j.err-%N

# * Environment
odir="/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Software\
/SingularityImages"

# * Load singularity/apptainer
module load apptainer

# * Version
container_version="25.2.3"

# * Environment
apptainer \
    build \
    "${odir}/fmriprep-${container_version}.simg" \
    "docker://nipreps/fmriprep:${container_version}"

exit
#+end_src

** TANGLE (local) :noexport:
:PROPERTIES:
:header-args:bash:  :shebang "#!/usr/bin/env bash"
:header-args:bash+: :tangle scripts/02_build_fmrirep.slurm
:header-args:bash+: :mkdirp yes
:header-args:bash+: :noweb yes
:END:

#+begin_src bash
<<build_fmriprep_chpc>>
#+end_src

** TANGLE (CHPC) :noexport:
:PROPERTIES:
:header-args:bash:  :shebang "#!/usr/bin/env bash"
:header-args:bash+: :tangle  /ssh:u6012627@notchpeak.chpc.utah.edu:/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Software/SingularityImages/build_fMRIprep_25.2.3.slurm
:header-args:bash+: :mkdirp yes
:header-args:bash+: :noweb yes
:END:

#+begin_src bash
<<build_fmriprep_chpc>>
#+end_src
