#+TITLE: fMRI Data Pre-processing

* Copy over data
:PROPERTIES:
:header-args:bash:  :tangle scripts/01_copy_data.sh
:header-args:bash+: :shebang "#!/usr/bin/env bash"
:header-args:bash+: :mkdirp yes
:END:

Copy over the data from network storage to CHPC.
#+begin_src bash
# * Copy data from the NAS to CHPC for processing

# * Environment
# ** Remote NAS (source)
r1id="vkoppelmans"
r1ip="eindhoven.synology.me"
r1dir="/volume1/Backup/Thalia/Kladblok/20190830_Koppelmans\
/20240816_NMD_fMRIprep_Tethys/data/20240715_BIDS"

# ** CHPC (target)
r2id="u6012627"
r2ip="notchpeak.chpc.utah.edu"
r2dir="/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Kladblok\
/20251114_NMD_fMRI"


# * Copy data from NAS to local
# NAS does not allow scp protocol, and rsync does not allow remote-to-remote
# copying, so I will need to copy the data over from NAS to local, and then from
# local to CHPC.

# ** Copy NAS to local
tdir=$(mktemp -d)
rsync -avmhe ssh ${r1id}@${r1ip}:${r1dir} "${tdir}"

# ** Copy local to CHPC
# * Create output folder
ssh "${r2id}@${r2ip}" mkdir -p "${r2dir}"

# ** Copy over the data
rsync -avmhe ssh "${tdir}/20240715_BIDS" ${r2id}@${r2ip}:${r2dir}
#+end_src

The total data size is 36.22G.

* Build fMRIprep on CHPC
:PROPERTIES:
:header-args:bash: :tangle no
:END:

#+NAME: build_fmriprep_chpc
#+begin_src bash
#SBATCH --account=koppelmans-np
#SBATCH --mail-user=u6012627@utah.edu
#SBATCH --partition=koppelmans-shared-np
#SBATCH --job-name=build_fmriprep
#SBATCH --nodes=1
#SBATCH --ntasks=20
#SBATCH --mem=24G
#SBATCH --time=3:00:00
#SBATCH -o build_fmriprep_sif-%j.out-%N
#SBATCH -e build_fmriprep_sif-%j.err-%N

# * Environment
odir="/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Software\
/SingularityImages"

# * Load singularity/apptainer
module load apptainer

# * Version
container_version="25.2.3"

# * Environment
apptainer \
    build \
    "${odir}/fmriprep-${container_version}.simg" \
    "docker://nipreps/fmriprep:${container_version}"

exit
#+end_src

** TANGLE (local) :noexport:
:PROPERTIES:
:header-args:bash:  :shebang "#!/usr/bin/env bash"
:header-args:bash+: :tangle scripts/02_build_fmrirep.slurm
:header-args:bash+: :mkdirp yes
:header-args:bash+: :noweb yes
:END:

#+begin_src bash
<<build_fmriprep_chpc>>
#+end_src

** TANGLE (CHPC) :noexport:
:PROPERTIES:
:header-args:bash:  :shebang "#!/usr/bin/env bash"
:header-args:bash+: :tangle  /ssh:u6012627@notchpeak.chpc.utah.edu:/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Software/SingularityImages/build_fMRIprep_25.2.3.slurm
:header-args:bash+: :mkdirp yes
:header-args:bash+: :noweb yes
:END:

#+begin_src bash
<<build_fmriprep_chpc>>
#+end_src

* Flip Brain of NMD004
:PROPERTIES:
:header-args:bash: :tangle no
:END:

We are analyzing dominant hand grip strength. Subject NMD004 is left handed, all others are right handed. I will flip the MRI data of the left-handed subject for group level analyses later.

#+NAME: lr_flip_brain_nmd004
#+begin_src bash
#SBATCH --account=koppelmans-np
#SBATCH --mail-user=u6012627@utah.edu
#SBATCH --partition=koppelmans-shared-np
#SBATCH --job-name=lr_flip_NMD004
#SBATCH --nodes=1
#SBATCH --ntasks=20
#SBATCH --mem=12G
#SBATCH --time=1:00:00
#SBATCH -o lr_flip_NMD004-%j.out-%N
#SBATCH -e lr_flip_NMD004-%j.err-%N

# This script makes a backup of the data of subject NMD004, the only left
# handed subject in the data set. It then flips the MRI data left-to-right to
# ensure that we will be able to do group level analyses for the dominant hand.

# * Environment
dir="/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Kladblok\
/20251114_NMD_fMRI/20240715_BIDS"
cd "${dir}" || exit


# * Load FSL module
module load fsl


# * Backup the original data
# Only do this if the backup file does not exists. This will prevent overwriting
# the true original data.
bkpfile="${dir}/sub-NMD004_non_flipped_bkp.gz"
if [ ! -f "${bkpfile}" ]; then
    echo "Backing up data for sub-NMD004"
    tar -zcf "${bkpfile}" "sub-NMD004"
    echo $(basename "${bkpfile}") >> .bidsignore
    echo "scripts/" >> .bidsignore
else
    echo "Data for sub-NMD004 already backed up. Skipping..."
fi


# * List NMD004's nifti files
ddir="${dir}/sub-NMD004"
files=($(find "${ddir}" -iname "*.nii.gz" | sort))


# * Flip each nifti file
for file in ${files[@]}; do

    fbase=$(echo "${file}" | sed "s#${ddir}#..#g")
    echo "$(tput setaf 3)Left-Right flipping:$(tput sgr0) ${fbase}"
    fslswapdim "${file}" -x y z "${file}"

done


exit
#+end_src

** TANGLE (local) :noexport:
:PROPERTIES:
:header-args:bash:  :shebang "#!/usr/bin/env bash"
:header-args:bash+: :tangle scripts/03_lr_flip_brain_nmd004.slurm
:header-args:bash+: :mkdirp yes
:header-args:bash+: :noweb yes
:END:

#+begin_src bash
<<lr_flip_brain_nmd004>>
#+end_src

** TANGLE (CHPC) :noexport:
:PROPERTIES:
:header-args:bash:  :shebang "#!/usr/bin/env bash"
:header-args:bash+: :tangle  /ssh:u6012627@notchpeak.chpc.utah.edu:/uufs/chpc.utah.edu/common/home/koppelmans-group1/20230809_Kladblok/20251114_NMD_fMRI/20240715_BIDS/scripts/lr_flip_brain_nmd004.slurm
:header-args:bash+: :mkdirp yes
:header-args:bash+: :noweb yes
:END:

#+begin_src bash
<<lr_flip_brain_nmd004>>
#+end_src
